<!DOCTYPE HTML>
<html>

<script>
    let darkMode = true;

    let darkPreview = "#7A7A7A";
    let lightPreview = "#FFFFFF";

    let bhbOutput = '';

</script>

<style>
    body {
        padding: 25px;
        background-color: #60646c;
        color: black;
        font-size: 25px;
    }

    input[type="text"]{
        background-color: #989ca4;
    }

    .light-mode-input input[type="text"]{
        background-color: white;
    }

    .light-mode {
        background-color: #f8f4f4;
        color: black;
    }

</style>

<body>

    <!--
        Dynamic page HTML setup
    -->
    <script>

        //Validate the hex color is good
        function isHexOk(hex) {
            return (hex.length == 6);
        }

        function lightMode() {
            var element = document.body;
            element.classList.toggle("light-mode");
            element.classList.toggle("light-mode-input");

            if (darkMode) darkMode = false;
            else darkMode = true;

            //Update preview backgrounds
            var previews = Array.prototype.slice.call(document.getElementsByClassName("color_preview"));
            previews.forEach(function (preview) {

                var currentColor = rgbToHex(preview.style.backgroundColor);

                if(currentColor == darkPreview || currentColor == lightPreview){
                    preview.style.backgroundColor = (darkMode ? lightPreview : darkPreview) 
                }
            });

        }

        function rgbToHex(col) {
            if (col.charAt(0) == 'r') {
                col = col.replace('rgb(', '').replace(')', '').split(',');
                var r = parseInt(col[0], 10).toString(16);
                var g = parseInt(col[1], 10).toString(16);
                var b = parseInt(col[2], 10).toString(16);
                r = r.length == 1 ? '0' + r : r; g = g.length == 1 ? '0' + g : g; b = b.length == 1 ? '0' + b : b;
                var colHex = '#' + r + g + b;
                return colHex.toUpperCase();
            }
        }

        function createCodeDiv(index) {
            var div = document.createElement('div');
            div.id = 'code_box' + index;

            //Create the applicable label for the code entering box
            var label = document.createElement('label');
            label.for = 'code_input' + index;
            label.innerHTML = 'Code ' + (index + 1) + ':';
            //Add padding between label and input
            label.style.paddingRight = '10px';

            //Create the color preview panes
            var colorPreview = document.createElement('input');
            colorPreview.type = 'button';
            colorPreview.id = 'color_preview' + index;
            colorPreview.classList.add('color_preview');
            colorPreview.style = "width: 22px; height: 22px; border: 2px solid black; border-radius: 2px;";
            //Set the color of the preview pane
            colorPreview.style.backgroundColor = darkMode ? "#FFFFFF" : "#000000";
            //"Clear" button
            colorPreview.onclick = function () {
                document.getElementById('code_input' + index).value = '';
                this.style.backgroundColor = darkMode ? '#FFFFFF' : '#000000';
            };

            //Create code entering box
            var rawIn = document.createElement('input');
            rawIn.index = index;
            rawIn.type = 'text';
            rawIn.id = 'code_input' + index;
            rawIn.style = "text-transform: uppercase; width: 50px; height: 22px; border: 2px solid black; margin-right: 10px; border-radius: 4px;";
            rawIn.style.paddingRight = '10px';
            rawIn.onchange = rawIn.onkeyup = function () {
                colorPreview.style.backgroundColor = (isHexOk(this.value) ? "#" + this.value : (darkMode ? "#FFFFFF" : "#000000"));
                checkInput();
            };
            //Handle tab and shift tab press
            rawIn.addEventListener('keydown', function (e) {
                if (e.keyCode == 9) {
                    e.preventDefault();
                    if (e.shiftKey && index > 0) document.getElementById('code_input' + (this.index - 1)).focus();
                    else if (index < 5) document.getElementById('code_input' + (this.index + 1)).focus();
                }
            });

            //Only allow valid hex chars as codes
            rawIn.addEventListener('keypress', function inputKeyPress(event) {

                var key = event.keyCode || event.charCode;

                if (key == 8 || key == 9 || key == 13 || key == 46 || key == 37 || key == 39) {
                    return true;
                }

                //Input can only be 6 chars long
                if (this.value.length >= 6) {
                    event.preventDefault();
                    return false;
                }

                var regex = new RegExp("^[A-Fa-f0-9]+$");
                var keyChar = String.fromCharCode(key);

                if (!regex.test(keyChar)) {
                    event.preventDefault();
                    return false;
                }
            });


            div.appendChild(label);
            div.appendChild(rawIn);
            div.appendChild(colorPreview);

            document.body.appendChild(div);
        }

        function checkInput() {
            //Need to be at least 2 valid codes
            var validCodes = 0;
            //Compile the code fields
            var codeFields = function () { var x = []; for (var i = 0; i < 6; i++) { x.push(document.getElementById('code_input' + i)); } return x; }();
            //Count number of valid codes
            codeFields.forEach(el => { if (isHexOk(el.value)) validCodes++; })
            //Build the preview if conditions are met
            if (validCodes >= 2 && (document.getElementById('main_enter_box').value.length >= (validCodes * 2) - 1)) {
                buildPreview(bhbOutput = blendMain(validCodes, document.getElementById('main_enter_box').value, codeFields.map(function (x) { return x.value; }), true));
            }
        }

        for (var i = 0; i < 6; i++) {
            createCodeDiv(i);
        }

    </script>

    <br>
    <label for="main_enter_box" style="padding-right: 10px;">Input:</label>
    <input type="text" id="main_enter_box" onkeyup="checkInput()" onchange="checkInput()">
    <br>
    <br>

    <!--
        Dynamic preview building
    -->
    <script>

        var div = document.createElement('div');
        div.id = 'preview_box';
        document.body.appendChild(div);

        function buildPreview(input) {

            //Clear old preview
            while (div.firstChild) {
                div.removeChild(div.firstChild);
            }

            /*
                Input will be in the form &#FF00FF{char}, etc., where each character will be preceded by a color code
                The following code will split the input into an array of corresponding color codes and characters:

                [#FF00FFA, #00FF00B, #0000FFC, etc.]
            */
            var inputSplit = input.split("&");
            //First index will be empty, shift it out
            inputSplit.shift();

            inputSplit.forEach(element => {
                var color = element.substring(0, 7);
                var char = element.substring(7, 8);

                var label = document.createElement('label');
                label.style = "color: " + color + ";";
                label.innerText = char;

                document.getElementById('preview_box').appendChild(label);
            });

        }



    </script>

    <!--
        Blending functions
    -->
    <script>
        function findSplitLengths(word, numSplits) {

            //List of lengths of each split
            var solutions = [];

            var roughSolution = parseInt(Math.ceil(parseFloat(word.length) / numSplits), 10);
            var remaining = word.length;

            var reduced = false;

            for (var i = 0; i < numSplits; ++i) {
                var x = (roughSolution - 1) * (numSplits - i);
                if (!reduced && x === remaining) {
                    roughSolution -= 1;
                    reduced = true;
                }

                solutions.push(roughSolution);
                remaining -= roughSolution;
            }

            return solutions;
        }

        function findSplits(rightJustified, splitsLengths, input) {

            var result = [];
            if (rightJustified) splitsLengths = splitsLengths.reverse();

            var newIndex = 0;
            for (var i = 0; i < splitsLengths.length; i++) {
                result[i] = input.substring(newIndex, newIndex + splitsLengths[i]);
                newIndex += splitsLengths[i];
            }

            return result;
        }

        function blendTwo(hexOne, hexTwo, input) {

            //Start to compile the output
            var output = "";

            //Put the R, G, and B values for each into an array
            componentsOne = [hexR(hexOne), hexG(hexOne), hexB(hexOne)];
            componentsDif = [hexR(hexTwo) - hexR(hexOne), hexG(hexTwo) - hexG(hexOne), hexB(hexTwo) - hexB(hexOne)];

            //Loop through each step
            for (var j = 0; j <= (input.length - 1); ++j) {
                output += "&#";
                for (var i = 0; i < 3; i++) {
                    output += pad(componentsOne[i] + (componentsDif[i] * (j / (input.length - 1)))).toLocaleUpperCase();
                }
                output += input[j];
            }

            return output;
        }

        function blendMain(howManyCodes, input, codeList, rightJustified) {

            //Create an output
            var output = "";
            var splitLengths = findSplitLengths(input, (howManyCodes - 1));
            var splits = findSplits(rightJustified, splitLengths, input);

            for (var i = 0, codeIndex = 0; i < splits.length; i++, codeIndex++) {
                if (i !== (splits.length - 1)) splits[i] = (splits[i] + splits[i + 1].substring(0, 1));

                var addendum = blendTwo(codeList[codeIndex], codeList[codeIndex + 1], splits[i]);
                output += (i !== (splits.length - 1) ? addendum.substring(0, addendum.length - 9) : addendum);
            }

            return output;
        }

        function pad(input) {

            var hex = Math.round(input).toString(16);
            return (hex.length === 1 ? "0" + hex : hex);
        }

        function hexR(hex) { return parseInt(hex.substring(0, 2), 16) }
        function hexG(hex) { return parseInt(hex.substring(2, 4), 16) }
        function hexB(hex) { return parseInt(hex.substring(4, 6), 16) }

    </script>

    <br>
    <button onclick="lightMode()">Toggle Dark Mode</button>

</body>

</html>