<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Blazin's Hex Blender</title>
    <link rel="icon" type="image/x-icon" href="resources/favicon.ico">
</head>

<script>
    let darkMode = true;

    let darkPreview = "#7A7A7A";
    let lightPreview = "#FFFFFF";

    let bhbOutput = '';

</script>

<style>
    body {
        padding: 25px;
        background-color: #60646c;
        color: black;
        font-size: 25px;
    }

    input[type="text"] {
        background-color: #989ca4;
    }

    input[type="color"] {
        background-color: #989ca4;
    }

    input:disabled {
        background-color: #787c84;
    }

    .light-mode {
        background-color: #f8f4f4;
        color: black;
    }

    .light-mode-text input[type="text"] {
        background-color: white;
    }

    .light-mode-color input[type="color"] {
        background-color: white;
    }

    .light-mode-disabled input:disabled {
        background-color: #d3d3d3;
    }
</style>

<body>

    <!--
        Dynamic page HTML setup
    -->
    <script>

        var masterCodeDiv = document.createElement("div");
        masterCodeDiv.id = "masterCodeDiv";
        masterCodeDiv.style.border = "3px solid black";
        masterCodeDiv.style.textAlign = "center";
        masterCodeDiv.style.borderRadius = '10px';
        masterCodeDiv.style.padding = '10px';
        masterCodeDiv.style.width = "13%";

        //Validate the hex color is good
        function isHexOk(hex) {
            return (hex.length == 6);
        }

        function lightMode() {
            var element = document.body;
            element.classList.toggle("light-mode");
            element.classList.toggle("light-mode-text");
            element.classList.toggle("light-mode-color");
            element.classList.toggle("light-mode-disabled");

            //Update preview backgrounds
            var previews = Array.prototype.slice.call(document.getElementsByClassName("color_preview"));
            previews.forEach(function (preview) {

                var currentColor = rgbToHex(preview.style.backgroundColor);

                if (currentColor == darkPreview || currentColor == lightPreview) {
                    preview.style.backgroundColor = (darkMode ? lightPreview : darkPreview)
                }
            });

            //Update picker backgrounds
            var pickers = Array.prototype.slice.call(document.getElementsByClassName("color_picker"));
            pickers.forEach(function (picker) {
                var currentVal = picker.value;

                console.log(currentVal);

                if (currentVal == darkPreview || currentVal == lightPreview) {
                    picker.value = (darkMode ? lightPreview : darkPreview)
                }
            });

            //Update button's backgrounds
            document.getElementById("lightModeButton").style.backgroundColor = (darkMode ? lightPreview : darkPreview);
            document.getElementById("clear_all").style.backgroundColor = (darkMode ? lightPreview : darkPreview);

            if (darkMode) darkMode = false;
            else darkMode = true;

        }

        function rgbToHex(col) {
            if (col.charAt(0) == 'r') {
                col = col.replace('rgb(', '').replace(')', '').split(',');
                var r = parseInt(col[0], 10).toString(16);
                var g = parseInt(col[1], 10).toString(16);
                var b = parseInt(col[2], 10).toString(16);
                r = r.length == 1 ? '0' + r : r; g = g.length == 1 ? '0' + g : g; b = b.length == 1 ? '0' + b : b;
                var colHex = '#' + r + g + b;
                return colHex.toUpperCase();
            }
        }

        function createCodeDiv(index) {
            var div = document.createElement('div');
            div.id = 'code_box' + index;

            //Create the applicable label for the code entering box
            var label = document.createElement('label');
            label.for = 'code_input' + index;
            label.innerHTML = 'Code ' + (index + 1) + ':';
            label.style = 'font-size: 20px;';
            //Add padding between label and input
            label.style.paddingRight = '10px';

            //Create the color picker
            var colorPicker = document.createElement('input');
            colorPicker.type = 'color';
            colorPicker.classList.add('color_picker');
            colorPicker.id = 'color_picker' + index;
            colorPicker.value = (darkMode ? darkPreview : lightPreview);
            colorPicker.addEventListener('change', function () {
                document.getElementById('code_input' + index).value = this.value.replace('#', '');
            });
            div.appendChild(colorPicker);

            //Create code entering box
            var rawIn = document.createElement('input');
            rawIn.index = index;
            rawIn.type = 'text';
            rawIn.classList.add('code_input');
            rawIn.id = 'code_input' + index;
            rawIn.style = "text-transform: uppercase; width: 50px; height: 22px; border: 2px solid black; margin-right: 10px; border-radius: 4px;";
            rawIn.style.paddingRight = '10px';
            rawIn.onchange = rawIn.onkeyup = function () {
                colorPicker.value = (isHexOk(this.value) ? '#' + this.value : (darkMode ? darkPreview : lightPreview));
                checkInput();
                unlockFields();
            };
            //Handle tab and shift tab press
            rawIn.addEventListener('keydown', function (e) {
                if (e.keyCode == 9) {
                    e.preventDefault();
                    if (e.shiftKey && index > 0) document.getElementById('code_input' + (this.index - 1)).focus();
                    else if (index < 5) document.getElementById('code_input' + (this.index + 1)).focus();
                    else if (index == 5) document.getElementById('main_enter_box').focus();
                }
            });


            //Only allow valid hex chars as codes
            var enterTypes = ['keydown', 'keyup', 'keypress', 'paste', 'cut'];
            enterTypes.forEach(function (type) {
                rawIn.addEventListener(type, function (e) {
                    var key = event.keyCode || event.charCode;

                if (key == 8 || key == 9 || key == 13 || key == 46 || key == 37 || key == 39) {
                    return true;
                }

                //Input can only be 6 chars long
                if (this.value.length >= 6) {
                    event.preventDefault();
                    return false;
                }

                var regex = new RegExp("^[A-Fa-f0-9]+$");
                var keyChar = String.fromCharCode(key);

                if (!regex.test(keyChar)) {
                    event.preventDefault();
                    return false;
                }
                });
            });

            //Add the label, input, and preview elems to the div
            div.appendChild(label);
            div.appendChild(rawIn);
            div.appendChild(colorPicker);

            //Add the div to the body
            masterCodeDiv.appendChild(div);
        }


        function createClearAll() {
            //Create "Clear All" button
            var clearAll = document.createElement('button');
            clearAll.type = 'button';
            clearAll.id = 'clear_all';
            clearAll.innerHTML = 'Clear All';
            clearAll.style = "width: 100px; height: 30px; border: 2px solid black; border-radius: 4px; margin-right: 10px;";
            clearAll.style.backgroundColor = (darkMode ? darkPreview : lightPreview);
            clearAll.style.alignSelf = 'center';
            clearAll.onclick = function () {
                var inputs = Array.prototype.slice.call(document.getElementsByClassName("code_input"));
                var pickers = Array.prototype.slice.call(document.getElementsByClassName("color_picker"));
                inputs.forEach(function (input) {
                    input.value = '';
                });
                pickers.forEach(function (picker) {
                    picker.value = (darkMode ? darkPreview : lightPreview);
                });
                checkInput();
                unlockFields();
            };
            masterCodeDiv.appendChild(clearAll);
        }

        //Figure out which fields should be enabled/disabled
        function unlockFields() {

            var fields = Array.prototype.slice.call(document.getElementsByClassName("code_input"));
            var pickers = Array.prototype.slice.call(document.getElementsByClassName("color_picker"));

            // f=field, i=index
            fields.forEach(function (f, i) {

                var val = f.value;
                if (val != '' && val.length == 6 && f.disabled == false && (i + 1 < 6) && isHexOk(val)) {
                    fields[i + 1].disabled = false;
                    pickers[i + 1].disabled = false;
                }
                else if (i + 1 < 6) {
                    fields[i + 1].disabled = true;
                    pickers[i + 1].disabled = true;
                }
            });
        }

        function checkInput() {
            //Need to be at least 2 valid codes
            var validCodes = 0;
            //Compile the code fields
            var codeFields = function () { var x = []; for (var i = 0; i < 6; i++) { x.push(document.getElementById('code_input' + i)); } return x; }();
            //Count number of valid codes
            codeFields.forEach(el => { if (isHexOk(el.value)) validCodes++; })
            //Build the preview if conditions are met
            if (validCodes >= 2 && (document.getElementById('main_enter_box').value.length >= (validCodes * 2) - 1)) {
                buildPreview(bhbOutput = blendMain(validCodes, document.getElementById('main_enter_box').value, codeFields.map(function (x) { return x.value; }), true));
            }
            else buildPreview(bhbOutput = '');

            document.getElementById('main_output_box').value = bhbOutput;
        }

        for (var i = 0; i < 6; i++) {
            createCodeDiv(i);
        }
        createClearAll();

        document.body.appendChild(masterCodeDiv);

        unlockFields();

    </script>

    <br>
    <label for="main_enter_box" style="padding-right: 10px;">Input:</label>
    <input type="text" id="main_enter_box">
    <input type="text" id="main_output_box" style="display: none;">

    <script>
        //Bind the input text box to catch all changes
        var mainInput = document.getElementById('main_enter_box');
        mainInput.onchange = mainInput.onkeyup = mainInput.onkeydown = mainInput.oninput = mainInput.oncut = mainInput.onpaste = function () {
            checkInput();
        };
    </script>

    <br id="cond-break-1" style="display: none;">
    <br id="cond-break-2" style="display: none;">

    <!--
        Dynamic preview building
    -->
    <script>

        //Setup the label for the preview
        var label = document.createElement('label');
        label.for = 'preview_box';
        label.innerHTML = 'Preview:';
        label.style.paddingRight = '10px';
        label.style.display = 'none';
        document.body.appendChild(label);

        //Create the master div that will hold the preview label container and the copy button
        var div = document.createElement('div');
        div.id = 'preview_box';
        div.style.padding = '10px';
        div.style.marginLeft = 'auto';
        div.style.marginRight = '0px';
        div.style.display = 'flex';
        div.style.justifyContent = 'space-around';
        div.style.resize = 'width';
        div.style.overflow = 'auto';
        document.body.appendChild(div);

        //Create a secondary div to contain the preview labels
        var div2 = document.createElement('div');
        div2.id = 'preview_label_container';

        //Create the copy button
        var copyButton = document.createElement('input');
        copyButton.type = 'button';
        copyButton.id = 'copy_button';
        copyButton.value = 'Copy to Clipboard';
        copyButton.style.display = 'none';
        //On click, copy the latest compiled output to the clipboard
        copyButton.onclick = function () {
            document.getElementById('main_output_box').style.display = 'inline';
            document.getElementById('main_output_box').select();
            document.execCommand('copy');
            document.getElementById('main_output_box').style.display = 'none';
        };

        //Add the secondary div and the copy button to the master div
        div.appendChild(copyButton);
        div.appendChild(div2);

        function buildPreview(input) {

            //Clear old preview
            while (div2.firstChild) {
                div2.removeChild(div2.firstChild);
            }

            /*
                Input will be in the form &#FF00FF{char}, etc., where each character will be preceded by a color code
                The following code will split the input into an array of corresponding color codes and characters:

                [#FF00FFA, #00FF00B, #0000FFC, etc.]
            */
            var inputSplit = input.split("&");
            //First index will be empty, shift it out
            inputSplit.shift();

            inputSplit.forEach(element => {
                var color = element.substring(0, 7);
                var char = element.substring(7, 8);

                var label = document.createElement('label');
                label.style = "color: " + color + ";";
                label.innerText = char;

                div2.appendChild(label);
            });

            //Show the preview if there is something to show
            if (div2.innerHTML == '') {
                div.style.border = '0px solid black';
                label.style.display = 'none';
                copyButton.style.display = 'none';
                document.getElementById('cond-break-1').style.display = 'none';
                document.getElementById('cond-break-2').style.display = 'none';
            }
            else {
                div.style.border = '2px solid black';
                label.style.display = 'inline';
                copyButton.style.display = 'inline';
                document.getElementById('cond-break-1').style.display = 'inline';
                document.getElementById('cond-break-2').style.display = 'inline';
            }

            div.appendChild(copyButton);
        }

    </script>

    <!--
        Blending functions
    -->
    <script>
        function findSplitLengths(word, numSplits) {

            //List of lengths of each split
            var solutions = [];

            var roughSolution = parseInt(Math.ceil(parseFloat(word.length) / numSplits), 10);
            var remaining = word.length;

            var reduced = false;

            for (var i = 0; i < numSplits; ++i) {
                var x = (roughSolution - 1) * (numSplits - i);
                if (!reduced && x === remaining) {
                    roughSolution -= 1;
                    reduced = true;
                }

                solutions.push(roughSolution);
                remaining -= roughSolution;
            }

            return solutions;
        }

        function findSplits(rightJustified, splitsLengths, input) {

            var result = [];
            if (rightJustified) splitsLengths = splitsLengths.reverse();

            var newIndex = 0;
            for (var i = 0; i < splitsLengths.length; i++) {
                result[i] = input.substring(newIndex, newIndex + splitsLengths[i]);
                newIndex += splitsLengths[i];
            }

            return result;
        }

        function blendTwo(hexOne, hexTwo, input) {

            //Start to compile the output
            var output = "";

            //Put the R, G, and B values for each into an array
            componentsOne = [hexR(hexOne), hexG(hexOne), hexB(hexOne)];
            componentsDif = [hexR(hexTwo) - hexR(hexOne), hexG(hexTwo) - hexG(hexOne), hexB(hexTwo) - hexB(hexOne)];

            //Loop through each step
            for (var j = 0; j <= (input.length - 1); ++j) {
                output += "&#";
                for (var i = 0; i < 3; i++) {
                    output += pad(componentsOne[i] + (componentsDif[i] * (j / (input.length - 1)))).toLocaleUpperCase();
                }
                output += input[j];
            }

            return output;
        }

        function blendMain(howManyCodes, input, codeList, rightJustified) {

            //Create an output
            var output = "";
            var splitLengths = findSplitLengths(input, (howManyCodes - 1));
            var splits = findSplits(rightJustified, splitLengths, input);

            for (var i = 0, codeIndex = 0; i < splits.length; i++, codeIndex++) {
                if (i !== (splits.length - 1)) splits[i] = (splits[i] + splits[i + 1].substring(0, 1));

                var addendum = blendTwo(codeList[codeIndex], codeList[codeIndex + 1], splits[i]);
                output += (i !== (splits.length - 1) ? addendum.substring(0, addendum.length - 9) : addendum);
            }

            return output;
        }

        function pad(input) {

            var hex = Math.round(input).toString(16);
            return (hex.length === 1 ? "0" + hex : hex);
        }

        function hexR(hex) { return parseInt(hex.substring(0, 2), 16) }
        function hexG(hex) { return parseInt(hex.substring(2, 4), 16) }
        function hexB(hex) { return parseInt(hex.substring(4, 6), 16) }

    </script>

    <br>
    <button id="lightModeButton" onclick="lightMode()">Toggle Dark Mode</button>
    <script>
        document.getElementById('lightModeButton').style.backgroundColor = (darkMode ? darkPreview : lightPreview);
    </script>

</body>

</html>