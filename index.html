<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Blazin's Hex Blender</title>
    <link rel="icon" type="image/x-icon" href="resources/favicon.ico">
</head>

<script>
    let darkMode = true;

    let darkPreview = "#7A7A7A";
    let lightPreview = "#FFFFFF";

    let bhbOutput = '';

    class Setting {

        constructor(name, description, initValue, options){
            this.name = name;
            this.description = description;
            this.value = initValue;
            this.options = options;
        }

        get value(){
            return this.value;
        }

        setValue(value){
            this.value ??= value;
        }

        // Do nothing by default, "override" in instances
        execute(){

        }
    }

</script>

<style>
    body {
        padding: 25px;
        background-color: #60646c;
        color: black;
        font-size: 25px;
    }

    input[type="text"] {
        background-color: #989ca4;
    }

    input[type="color"] {
        background-color: #989ca4;
    }

    input:disabled {
        background-color: #787c84;
    }

    .light-mode {
        background-color: #f8f4f4;
        color: black;
    }

    .light-mode-text input[type="text"] {
        background-color: white;
    }

    .light-mode-color input[type="color"] {
        background-color: white;
    }

    .light-mode-disabled input:disabled {
        background-color: #d3d3d3;
    }
</style>

<body>

    <!--
        Dynamic page HTML setup
    -->
    <script>

        var masterCodeDiv = document.createElement("div");
        masterCodeDiv.id = "masterCodeDiv";
        masterCodeDiv.style.border = "3px solid black";
        masterCodeDiv.style.textAlign = "center";
        masterCodeDiv.style.borderRadius = '10px';
        masterCodeDiv.style.padding = '10px';
        masterCodeDiv.style.width = "13%";

        //Validate the hex color is good
        function isHexOk(hex) {
            return (hex.length == 6);
        }

        function lightMode() {
            var element = document.body;
            element.classList.toggle("light-mode");
            element.classList.toggle("light-mode-text");
            element.classList.toggle("light-mode-color");
            element.classList.toggle("light-mode-disabled");

            //Update picker backgrounds
            var pickers = Array.prototype.slice.call(document.getElementsByClassName("color_picker"));
            pickers.forEach(function (picker) {
                var currentVal = picker.value.toUpperCase();

                if (currentVal == darkPreview || currentVal == lightPreview) {
                    picker.value = (darkMode ? lightPreview : darkPreview)
                }
            });

            //Update button's backgrounds
            document.getElementById("lightModeButton").style.backgroundColor = (darkMode ? lightPreview : darkPreview);
            document.getElementById("clear_all").style.backgroundColor = (darkMode ? lightPreview : darkPreview);
            document.getElementById("copy_button").style.backgroundColor = (darkMode ? lightPreview : darkPreview);
            document.getElementById("slotMachineButton").style.backgroundColor = (darkMode ? lightPreview : darkPreview);

            if (darkMode) darkMode = false;
            else darkMode = true;

            //Update the cookie
            updateCookie();
        }

        function rgbToHex(col) {
            if (col.charAt(0) == 'r') {
                col = col.replace('rgb(', '').replace(')', '').split(',');
                var r = parseInt(col[0], 10).toString(16);
                var g = parseInt(col[1], 10).toString(16);
                var b = parseInt(col[2], 10).toString(16);
                r = r.length == 1 ? '0' + r : r; g = g.length == 1 ? '0' + g : g; b = b.length == 1 ? '0' + b : b;
                var colHex = '#' + r + g + b;
                return colHex.toUpperCase();
            }
        }

        function createCodeDiv(index) {
            var div = document.createElement('div');
            div.id = 'code_box' + index;

            //Create the applicable label for the code entering box
            var label = document.createElement('label');
            label.for = 'code_input' + index;
            label.innerHTML = 'Code ' + (index + 1) + ':';
            label.style = 'font-size: 20px;';
            //Add padding between label and input
            label.style.paddingRight = '10px';

            //Create the color picker
            var colorPicker = document.createElement('input');
            colorPicker.type = 'color';
            colorPicker.classList.add('color_picker');
            colorPicker.id = 'color_picker' + index;
            colorPicker.value = (darkMode ? darkPreview : lightPreview);
            colorPicker.addEventListener('change', function () {
                document.getElementById('code_input' + index).value = this.value.replace('#', '');
                unlockFields();
            });
            div.appendChild(colorPicker);

            //Create code entering box
            var rawIn = document.createElement('input');
            rawIn.index = index;
            rawIn.type = 'text';
            rawIn.classList.add('code_input');
            rawIn.id = 'code_input' + index;
            rawIn.style = "text-transform: uppercase; width: 50px; height: 22px; border: 2px solid black; margin-right: 10px; border-radius: 4px;";
            rawIn.style.paddingRight = '10px';
            rawIn.onchange = rawIn.onkeyup = rawIn.onchange = function () {
                colorPicker.value = (isHexOk(this.value) ? '#' + this.value : (darkMode ? darkPreview : lightPreview));
                checkInput();
                unlockFields();
            };
            //Handle tab and shift tab press
            rawIn.addEventListener('keydown', function (e) {
                if (e.keyCode == 9) {
                    e.preventDefault();
                    if (e.shiftKey && index > 0) document.getElementById('code_input' + (this.index - 1)).focus();
                    else if (index < 5) {

                        var nextEl = document.getElementById('code_input' + (this.index + 1));

                        if(nextEl.disabled == false)  nextEl.focus();
                        else document.getElementById('main_enter_box').focus();
                    }
                    else if (index == 5) document.getElementById('main_enter_box').focus();
                }
            });


            //Only allow valid hex chars as codes
            var enterTypes = ['keydown', 'keyup', 'keypress', 'paste', 'cut'];
            enterTypes.forEach(function (type) {
                rawIn.addEventListener(type, function (e) {
                    var key = event.keyCode || event.charCode;

                if (key == 8 || key == 9 || key == 13 || key == 46 || key == 37 || key == 39) {
                    return true;
                }

                //Input can only be 6 chars long
                if (this.value.length >= 6) {
                    event.preventDefault();
                    return false;
                }

                var regex = new RegExp("^[A-Fa-f0-9]+$");
                var keyChar = String.fromCharCode(key);

                if (!regex.test(keyChar)) {
                    event.preventDefault();
                    return false;
                }
                });
            });

            //Add the label, input, and preview elems to the div
            div.appendChild(label);
            div.appendChild(rawIn);
            div.appendChild(colorPicker);

            //Add the div to the body
            masterCodeDiv.appendChild(div);
        }


        function createClearAll() {
            //Create "Clear All" button
            var clearAll = document.createElement('button');
            clearAll.type = 'button';
            clearAll.id = 'clear_all';
            clearAll.innerHTML = 'Clear All';
            clearAll.style = "width: 100px; height: 30px; border: 2px solid black; border-radius: 4px; margin-right: 10px;";
            clearAll.style.backgroundColor = (darkMode ? darkPreview : lightPreview);
            clearAll.style.marginTop = '10px';
            clearAll.onclick = function () {
                var inputs = Array.prototype.slice.call(document.getElementsByClassName("code_input"));
                var pickers = Array.prototype.slice.call(document.getElementsByClassName("color_picker"));
                inputs.forEach(function (input) {
                    input.value = '';
                });
                pickers.forEach(function (picker) {
                    picker.value = (darkMode ? darkPreview : lightPreview);
                });
                checkInput();
                unlockFields();
            };
            masterCodeDiv.appendChild(clearAll);
        }

        //Figure out which fields should be enabled/disabled
        function unlockFields() {

            var fields = Array.prototype.slice.call(document.getElementsByClassName("code_input"));
            var pickers = Array.prototype.slice.call(document.getElementsByClassName("color_picker"));

            // f=field, i=index
            fields.forEach(function (f, i) {

                var val = f.value;
                if (val != '' && val.length == 6 && f.disabled == false && (i + 1 < 6) && isHexOk(val)) {
                    fields[i + 1].disabled = false;
                    pickers[i + 1].disabled = false;
                }
                else if (i + 1 < 6) {
                    fields[i + 1].disabled = true;
                    pickers[i + 1].disabled = true;
                }
            });
        }

        function updateCookie(){
            
            //Clear current cookie
            deleteAllCookies();

            //Start compiling the cookie
            var cookie = '';

            //Add code fields to the cookie
            var fields = Array.prototype.slice.call(document.getElementsByClassName("code_input"));
            fields.forEach(function (f, i) {
                if(f.value != '' && isHexOk(f.value)) cookie += f.value + ',';
            });
            cookie = cookie.slice(0, -1);

            //Add the entered input to the cookie
            cookie += '|' + document.getElementById('main_enter_box').value;
            
            //Add dark mode to cookie
            cookie += '|' + darkMode;

            //Don't care if the cookie is empty
            if(cookie == '') return;

            document.cookie = cookie + '; samesite=none; secure; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/';
        }

        function deleteAllCookies() {
            var cookies = document.cookie.split(";");

            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i];
                var eqPos = cookie.indexOf("=");
                var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = name + "=; samesite=none; secure; expires=Thu, 01 Jan 1970 00:00:00 GMT";
            }
        }

        function handleCookie(){
            var cookie = document.cookie;
            if(cookie == '') return;

            var codes = cookie.split('|')[0].split(',');
            var input = cookie.split('|')[1];
            var dark = cookie.split('|')[2];

            //Handle codes in cookie
            var fields = Array.prototype.slice.call(document.getElementsByClassName("code_input"));
            fields.forEach((f,i) => {
                if(codes[i] && isHexOk(codes[i])) f.value = codes[i];
                f.dispatchEvent(new Event('change'));
            });

            //Handle input in cookie
            if(input) document.getElementById('main_enter_box').value = input;

            //Handle dark mode in cookie
            if(dark == 'false') lightMode();
        }

        function checkInput() {
            //Need to be at least 2 valid codes
            var validCodes = 0;
            //Compile the code fields
            var codeFields = function () { var x = []; for (var i = 0; i < 6; i++) { x.push(document.getElementById('code_input' + i)); } return x; }();
            //Count number of valid codes
            codeFields.forEach(el => { if (isHexOk(el.value)) validCodes++; })
            //Build the preview if conditions are met
            if (validCodes >= 2 && (document.getElementById('main_enter_box').value.length >= (validCodes * 2) - 1)) {
                buildPreview(bhbOutput = blendMain(validCodes, document.getElementById('main_enter_box').value, codeFields.map(function (x) { return x.value; }), true));
            }
            else buildPreview(bhbOutput = '');

            updateCookie();
            document.getElementById('main_output_box').value = bhbOutput;
        }

        for (var i = 0; i < 6; i++) {
            createCodeDiv(i);
        }
        createClearAll();

        document.body.appendChild(masterCodeDiv);
        unlockFields();

    </script>

    <br>

    <!--
        Static HTML creation and setup
    -->
    <script>

        //Create the div to hold the input box
        var div = document.createElement('div');
        div.style.border = '3px solid black';
        div.style.borderRadius = '5px';
        div.style.padding = '10px';
        div.style.width = "30%";

        var label = document.createElement('label');
        label.for = 'main_enter_box';
        label.innerHTML = 'Input:';
        label.style.paddingRight = '10px';

        var mainEnterBox = document.createElement('input');
        mainEnterBox.type = 'text';
        mainEnterBox.id = 'main_enter_box';
        mainEnterBox.style = "width: 70%; height: 30px; border: 2px solid black; margin-right: 10px; border-radius: 4px; padding-left: 10px;";
        mainEnterBox.onchange = mainEnterBox.onkeyup = mainEnterBox.onkeydown = mainEnterBox.oninput = mainEnterBox.oncut = mainEnterBox.onpaste = function () {
            checkInput();
        };

        div.appendChild(label);
        div.appendChild(mainEnterBox);
        document.body.appendChild(div);

    </script>

    <input type="text" id="main_output_box" style="display: none;">

    <br id="cond-break-1" style="display: none;">

    <!--
        Dynamic preview building
    -->
    <script>

        //Create the master div that will hold the preview label container and the copy button
        var div = document.createElement('div');
        div.id = 'preview_box';
        div.style.border = '3px solid black';
        div.style.borderRadius = '5px';
        div.style.padding = '10px';
        div.style.justifyContent = 'space-around';
        div.style.width = "30%";
        document.body.appendChild(div);

        //Setup the label for the preview
        var label = document.createElement('label');
        label.for = 'preview_box';
        label.innerHTML = 'Preview:';
        label.style.paddingRight = '10px';
        label.style.display = 'none';
        div.appendChild(label);

        //Create a secondary div to contain the preview labels
        var div2 = document.createElement('div');
        div2.id = 'preview_label_container';
        div2.style.marginTop = '5px';
        div2.style.marginBottom = '5px';

        //Create the copy button
        var copyButton = document.createElement('input');
        copyButton.type = 'button';
        copyButton.id = 'copy_button';
        copyButton.value = 'Copy to Clipboard';
        copyButton.style = "width: 150px; height: 30px; border: 2px solid black; border-radius: 4px; margin-right: 10px; margin-top: 5px;";
        copyButton.style.backgroundColor = (darkMode ? darkPreview : lightPreview);
        copyButton.style.display = 'none';
        //On click, copy the latest compiled output to the clipboard
        copyButton.onclick = function () {
            document.getElementById('main_output_box').style.display = 'inline';
            document.getElementById('main_output_box').select();
            document.execCommand('copy');
            document.getElementById('main_output_box').style.display = 'none';
        };

        //Add the secondary div and the copy button to the master div
        div.appendChild(copyButton);
        div.appendChild(div2);

        function buildPreview(input) {

            //Clear old preview
            while (div2.firstChild) {
                div2.removeChild(div2.firstChild);
            }

            /*
                Input will be in the form &#FF00FF{char}, etc., where each character will be preceded by a color code
                The following code will split the input into an array of corresponding color codes and characters:

                [#FF00FFA, #00FF00B, #0000FFC, etc.]
            */
            var inputSplit = input.split("&");
            //First index will be empty, shift it out
            inputSplit.shift();

            inputSplit.forEach(element => {
                var color = element.substring(0, 7);
                var char = element.substring(7, 8);

                var label = document.createElement('label');
                label.style = "color: " + color + ";";
                label.innerText = char;

                div2.appendChild(label);
            });

            //Show the preview if there is something to show
            if (div2.innerHTML == '') {
                div.style.border = '0px solid black';
                label.style.display = 'none';
                copyButton.style.display = 'none';
                document.getElementById('cond-break-1').style.display = 'none';
            }
            else {
                div.style.border = '3px solid black';
                label.style.display = 'inline';
                copyButton.style.display = 'inline';
                document.getElementById('cond-break-1').style.display = 'inline';
            }

            div.appendChild(copyButton);
        }

    </script>

    <!--
        Blending functions
    -->
    <script>
        function findSplitLengths(word, numSplits) {

            //List of lengths of each split
            var solutions = [];

            var roughSolution = parseInt(Math.ceil(parseFloat(word.length) / numSplits), 10);
            var remaining = word.length;

            var reduced = false;

            for (var i = 0; i < numSplits; ++i) {
                var x = (roughSolution - 1) * (numSplits - i);
                if (!reduced && x === remaining) {
                    roughSolution -= 1;
                    reduced = true;
                }

                solutions.push(roughSolution);
                remaining -= roughSolution;
            }

            return solutions;
        }

        function findSplits(rightJustified, splitsLengths, input) {

            var result = [];
            if (rightJustified) splitsLengths = splitsLengths.reverse();

            var newIndex = 0;
            for (var i = 0; i < splitsLengths.length; i++) {
                result[i] = input.substring(newIndex, newIndex + splitsLengths[i]);
                newIndex += splitsLengths[i];
            }

            return result;
        }

        function blendTwo(hexOne, hexTwo, input) {

            //Start to compile the output
            var output = "";

            //Put the R, G, and B values for each into an array
            componentsOne = [hexR(hexOne), hexG(hexOne), hexB(hexOne)];
            componentsDif = [hexR(hexTwo) - hexR(hexOne), hexG(hexTwo) - hexG(hexOne), hexB(hexTwo) - hexB(hexOne)];

            //Loop through each step
            for (var j = 0; j <= (input.length - 1); ++j) {
                output += "&#";
                for (var i = 0; i < 3; i++) {
                    output += pad(componentsOne[i] + (componentsDif[i] * (j / (input.length - 1)))).toLocaleUpperCase();
                }
                output += input[j];
            }

            return output;
        }

        function blendMain(howManyCodes, input, codeList, rightJustified) {

            //Create an output
            var output = "";
            var splitLengths = findSplitLengths(input, (howManyCodes - 1));
            var splits = findSplits(rightJustified, splitLengths, input);

            for (var i = 0, codeIndex = 0; i < splits.length; i++, codeIndex++) {
                if (i !== (splits.length - 1)) splits[i] = (splits[i] + splits[i + 1].substring(0, 1));

                var addendum = blendTwo(codeList[codeIndex], codeList[codeIndex + 1], splits[i]);
                output += (i !== (splits.length - 1) ? addendum.substring(0, addendum.length - 9) : addendum);
            }

            return output;
        }

        function pad(input) {

            var hex = Math.round(input).toString(16);
            return (hex.length === 1 ? "0" + hex : hex);
        }

        function hexR(hex) { return parseInt(hex.substring(0, 2), 16) }
        function hexG(hex) { return parseInt(hex.substring(2, 4), 16) }
        function hexB(hex) { return parseInt(hex.substring(4, 6), 16) }

    </script>

    <!--
        Misc. Functions
    -->
    <script>
        async function slotMachine(){

            var codeBoxesArr = Array.prototype.slice.call(document.getElementsByClassName("code_input"));

            var intProgress = 0;

            animate({//Timing loop
                duration: 2520,
                timing: function(timeFraction) {
                    return timeFraction;
                },
                draw: function(progress) {
                    if(progress % 2!= 0) {
                            for(var j = 5; j >= Math.floor(intProgress / 40); --j) {
                            codeBoxesArr[j].value = randomColor();
                            document.getElementById('color_picker' + codeBoxesArr[j].index).value = "#" + codeBoxesArr[j].value;
                            checkInput();
                        }
                    }
                    sleep(4);
                    intProgress++;
                }
            });
        }

        function randomColor(){
            var rndHex = '';
            for(let i = 0; i < 6; i++) rndHex += "0123456789ABCDEF".charAt(Math.floor(Math.random() * 16));
            return rndHex;
        }

        /*
            Sleep for [delay] number of milliseconds
        */
        function sleep(delay){
            var start = new Date().getTime();
            while(new Date().getTime() < start + delay);
        }

        function animate({ timing, draw, duration }) {

            let start = performance.now();

            requestAnimationFrame(function animate(time) {
                // timeFraction goes from 0 to 1
                let timeFraction = (time - start) / duration;
                if (timeFraction > 1) timeFraction = 1;

                // calculate the current animation state
                let progress = timing(timeFraction)

                draw(progress); // draw it

                if (timeFraction < 1) {
                    requestAnimationFrame(animate);
                }

            });
        }



    </script>

    <br>

    <div id="utilDiv" style="border: 3px solid black; display: flex; border-radius: 5px; padding: 10px; vertical-align: middle; justify-content: space-around; width: 30%">
        <label for="utilDiv" style="padding-right: 10px;">Utilities:</label>
        <button 
            id="lightModeButton" 
            onclick="lightMode()"
            style="width: 100px; height: 40px; border: 2px solid black; border-radius: 4px; margin-right: 10px;">
                Toggle Dark Mode
        </button>
        <button 
            id="slotMachineButton" 
            onclick="slotMachine()"
            style="width: 100px; height: 40px; border: 2px solid black; border-radius: 4px; margin-right: 10px;">
                Slot Machine
        </button>
    </div>

    
    <!--
        Utility Creation
    -->
    <script>
        document.getElementById('lightModeButton').style.backgroundColor = (darkMode ? darkPreview : lightPreview); 
        document.getElementById('slotMachineButton').style.backgroundColor = (darkMode ? darkPreview : lightPreview);
    </script>

    <script>
        //Handle cookie
        handleCookie();
        checkInput();
        unlockFields();
    </script>

</body>

</html>